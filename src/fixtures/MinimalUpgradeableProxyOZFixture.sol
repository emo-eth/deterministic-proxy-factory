// SPDX-License-Identifier: MIT
pragma solidity ^0.8.4;

import { MINIMAL_PROXY_OZ_ADDRESS, MINIMAL_PROXY_OZ_SALT } from "src/Constants.sol";
import { MinimalUpgradeableProxyOZ } from "src/MinimalUpgradeableProxyOZ.sol";

/**
 * @title MinimalUpgradeableProxyOZFixture
 * @notice A helper library for deploying the MinimalUpgradeableProxyOZ in tests. Import and call in
 * the setUp() function.
 */
library MinimalUpgradeableProxyOZFixture {

    bytes constant MINIMAL_PROXY_OZ_INITCODE =
        hex"60a080604052346100c257306080525f516020610cd75f395f51905f525460ff8160401c166100b3576002600160401b03196001600160401b03821601610060575b604051610c1090816100c7823960805181818161051501526106340152f35b6001600160401b0319166001600160401b039081175f516020610cd75f395f51905f525581527fc7f505b2f371ae2175ee4913f4499e1f2633a7b5936321eed1cdaeb6115181d290602090a15f80610041565b63f92ee8a960e01b5f5260045ffd5b5f80fdfe60806040526004361015610011575f80fd5b5f3560e01c80634f1ef2861461058d57806352d1902d146104d0578063715018a6146103f65780638da5cb5b14610386578063ad3cb1cc146102d4578063c4d66de8146100b35763f2fde38b14610066575f80fd5b346100af5760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100af576100ad6100a06108ef565b6100a8610aa7565b6109ba565b005b5f80fd5b346100af5760207ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100af576100ea6108ef565b7ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a005460ff8160401c16159167ffffffffffffffff8216801590816102cc575b60011490816102c2575b1590816102b9575b5061029157818360017fffffffffffffffffffffffffffffffffffffffffffffffff00000000000000006101a39516177ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a005561023c575b5061019b610b13565b6100a8610b13565b6101a957005b7fffffffffffffffffffffffffffffffffffffffffffffff00ffffffffffffffff7ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a0054167ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a00557fc7f505b2f371ae2175ee4913f4499e1f2633a7b5936321eed1cdaeb6115181d2602060405160018152a1005b7fffffffffffffffffffffffffffffffffffffffffffffff0000000000000000001668010000000000000001177ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a005583610192565b7ff92ee8a9000000000000000000000000000000000000000000000000000000005f5260045ffd5b9050158461013b565b303b159150610133565b849150610129565b346100af575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100af5760408051906103118183610912565b6005825260208201917f352e302e3000000000000000000000000000000000000000000000000000000083527fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0601f8351948593602085525180918160208701528686015e5f85828601015201168101030190f35b346100af575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100af57602073ffffffffffffffffffffffffffffffffffffffff7f9016d09d72d40fdae2fd8ceac6b6234c7706214fd39c1cd1e609a0528c1993005416604051908152f35b346100af575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100af5761042c610aa7565b5f73ffffffffffffffffffffffffffffffffffffffff7f9016d09d72d40fdae2fd8ceac6b6234c7706214fd39c1cd1e609a0528c199300547fffffffffffffffffffffffff000000000000000000000000000000000000000081167f9016d09d72d40fdae2fd8ceac6b6234c7706214fd39c1cd1e609a0528c19930055167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e08280a3005b346100af575f7ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100af5773ffffffffffffffffffffffffffffffffffffffff7f00000000000000000000000000000000000000000000000000000000000000001630036105655760206040517f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc8152f35b7fe07c8dba000000000000000000000000000000000000000000000000000000005f5260045ffd5b60407ffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffc3601126100af576105bf6108ef565b6024359067ffffffffffffffff82116100af57366023830112156100af578160040135906105ec82610980565b916105fa6040519384610912565b808352602083019336602483830101116100af57815f9260246020930187378401015273ffffffffffffffffffffffffffffffffffffffff7f0000000000000000000000000000000000000000000000000000000000000000168030149081156108ad575b506105655761066c610aa7565b73ffffffffffffffffffffffffffffffffffffffff8116926040517f52d1902d000000000000000000000000000000000000000000000000000000008152602081600481885afa5f9181610879575b506106ec57847f4c9c8ce3000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b807f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc86920361084e5750823b1561082357807fffffffffffffffffffffffff00000000000000000000000000000000000000007f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc5416177f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc557fbc7cd75a20ee27fd9adebab32041f755214dbc6bffa90cc0225b39da2e5c2d3b5f80a28251156107f1575f80916100ad945190845af43d156107e9573d916107cd83610980565b926107db6040519485610912565b83523d5f602085013e610b6a565b606091610b6a565b505050346107fb57005b7fb398979f000000000000000000000000000000000000000000000000000000005f5260045ffd5b7f4c9c8ce3000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b7faa1d49a4000000000000000000000000000000000000000000000000000000005f5260045260245ffd5b9091506020813d6020116108a5575b8161089560209383610912565b810103126100af575190866106bb565b3d9150610888565b905073ffffffffffffffffffffffffffffffffffffffff7f360894a13ba1a3210667c828492db98dca3e2076cc3735a920a3ca505d382bbc541614158461065f565b6004359073ffffffffffffffffffffffffffffffffffffffff821682036100af57565b90601f7fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe0910116810190811067ffffffffffffffff82111761095357604052565b7f4e487b71000000000000000000000000000000000000000000000000000000005f52604160045260245ffd5b67ffffffffffffffff811161095357601f017fffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffe01660200190565b73ffffffffffffffffffffffffffffffffffffffff168015610a7b5773ffffffffffffffffffffffffffffffffffffffff7f9016d09d72d40fdae2fd8ceac6b6234c7706214fd39c1cd1e609a0528c19930054827fffffffffffffffffffffffff00000000000000000000000000000000000000008216177f9016d09d72d40fdae2fd8ceac6b6234c7706214fd39c1cd1e609a0528c19930055167f8be0079c531659141344cd1fd0a4f28419497f9722a3daafe3b4186f6b6457e05f80a3565b7f1e4fbdf7000000000000000000000000000000000000000000000000000000005f525f60045260245ffd5b73ffffffffffffffffffffffffffffffffffffffff7f9016d09d72d40fdae2fd8ceac6b6234c7706214fd39c1cd1e609a0528c19930054163303610ae757565b7f118cdaa7000000000000000000000000000000000000000000000000000000005f523360045260245ffd5b60ff7ff0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a005460401c1615610b4257565b7fd7e6bcf8000000000000000000000000000000000000000000000000000000005f5260045ffd5b90610ba75750805115610b7f57805190602001fd5b7fd6bda275000000000000000000000000000000000000000000000000000000005f5260045ffd5b81511580610bfa575b610bb8575090565b73ffffffffffffffffffffffffffffffffffffffff907f9996b315000000000000000000000000000000000000000000000000000000005f521660045260245ffd5b50803b15610bb056fea164736f6c634300081d000af0c57e16840df040f15088dc2f81fe391c3923bec73e23a9662efc9c229c6a00";

    address constant CREATE2_FACTORY = 0x4e59b44847b379578588920cA78FbF26c0B4956C;
    MinimalUpgradeableProxyOZ internal constant MINIMAL_UPGRADEABLE_PROXY_OZ_IMPLEMENTATION =
        MinimalUpgradeableProxyOZ(MINIMAL_PROXY_OZ_ADDRESS);

    function setUpMinimalUpgradeableProxyOZFixture() public returns (address) {
        if (address(MINIMAL_UPGRADEABLE_PROXY_OZ_IMPLEMENTATION).code.length > 0) {
            return MINIMAL_PROXY_OZ_ADDRESS;
        }

        (bool success, bytes memory result) =
            CREATE2_FACTORY.call(abi.encodePacked(MINIMAL_PROXY_OZ_SALT, MINIMAL_PROXY_OZ_INITCODE));
        bytes20 resultBytes;
        /// @solidity memory-safe-assembly
        assembly {
            resultBytes := mload(add(result, 0x20))
        }
        address resultAddress = address(resultBytes);
        require(success, "Failed to deploy MinimalUpgradeableProxyOZ");
        require(
            resultAddress == MINIMAL_PROXY_OZ_ADDRESS, "MinimalUpgradeableProxyOZ address mismatch"
        );
        return resultAddress;
    }

    function getAddress() public pure returns (address) {
        return address(MINIMAL_UPGRADEABLE_PROXY_OZ_IMPLEMENTATION);
    }

    function getType() public pure returns (MinimalUpgradeableProxyOZ) {
        return MINIMAL_UPGRADEABLE_PROXY_OZ_IMPLEMENTATION;
    }

}
